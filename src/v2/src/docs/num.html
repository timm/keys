<!DOCTYPE html>

<html>
<head>
  <title>num.lua</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>num.lua</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">local</span> Num={}
<span class="hljs-keyword">local</span> obj =<span class="hljs-built_in">require</span><span class="hljs-string">&quot;obj&quot;</span>
<span class="hljs-keyword">local</span> some=<span class="hljs-built_in">require</span><span class="hljs-string">&quot;some&quot;</span>
<span class="hljs-keyword">local</span> col =<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;col&quot;</span>).weight
<span class="hljs-keyword">local</span> _   =<span class="hljs-built_in">require</span>(<span class="hljs-string">&quot;list&quot;</span>); <span class="hljs-keyword">local</span> copy=_.copy</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>new(?at : int=0, ?name : str=””)  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:new</span><span class="hljs-params">()</span></span>
  name= name <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>
  <span class="hljs-keyword">return</span> obj(<span class="hljs-built_in">self</span>,<span class="hljs-string">&quot;Num&quot;</span>,{n=<span class="hljs-number">0</span>, some=Some(), name=name <span class="hljs-keyword">or</span> <span class="hljs-string">&quot;&quot;</span>,
                         at=at <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>, w=weight(name)}) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>add(x : num)  </p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:add1</span><span class="hljs-params">(x,    d)</span></span>
  d       = x - <span class="hljs-built_in">self</span>.mu
  <span class="hljs-built_in">self</span>.mu = <span class="hljs-built_in">self</span>.mu + d/<span class="hljs-built_in">self</span>.n
  <span class="hljs-built_in">self</span>.m2 = <span class="hljs-built_in">self</span>.m2 + d*(x - <span class="hljs-built_in">self</span>.mu)
  <span class="hljs-built_in">self</span>.sd = (<span class="hljs-built_in">self</span>.m2&lt;<span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-built_in">self</span>.n&lt;<span class="hljs-number">2</span>) <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> (
            (<span class="hljs-built_in">self</span>.m2/(<span class="hljs-built_in">self</span>.n<span class="hljs-number">-1</span>))^<span class="hljs-number">0.5</span>)
  <span class="hljs-built_in">self</span>.lo = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">min</span>(x, <span class="hljs-built_in">self</span>.lo)
  <span class="hljs-built_in">self</span>.hi = <span class="hljs-built_in">math</span>.<span class="hljs-built_in">max</span>(x, <span class="hljs-built_in">self</span>.hi)  <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>delta(other : Num)<br>Return the difference in the means, mediated by the variances.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:delta</span><span class="hljs-params">(other,    y,z,e)</span></span>
  e, y, z = <span class="hljs-number">1E-32</span>, <span class="hljs-built_in">self</span>, other
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(y.mu - z.mu) / (
         (e + y.sd^<span class="hljs-number">2</span>/y.n + z.sd^<span class="hljs-number">2</span>/z.n)^<span class="hljs-number">.5</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>dist(x : num, y : num)<br> If any value missing, guess a value of the other that
maximizes the distance.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:dist</span><span class="hljs-params">(x,y)</span></span>
  <span class="hljs-keyword">if</span>     x==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> y=<span class="hljs-built_in">self</span>:norm(y); x = y&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> 
  <span class="hljs-keyword">elseif</span> y==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> x=<span class="hljs-built_in">self</span>:norm(x); y = x&gt;<span class="hljs-number">.5</span> <span class="hljs-keyword">and</span> <span class="hljs-number">0</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span> 
  <span class="hljs-keyword">else</span>               x,y = <span class="hljs-built_in">self</span>:norm(x), <span class="hljs-built_in">self</span>:norm(y) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">abs</span>(x-y) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>merge(lst : num+)<br>Combine self with  a <code>lst</code> of other <code>Num</code>s.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:merge</span><span class="hljs-params">(lst,      new)</span></span>
  new = copy(<span class="hljs-built_in">self</span>)
  <span class="hljs-keyword">for</span> _,x <span class="hljs-keyword">in</span> <span class="hljs-built_in">pairs</span>(lst._all) <span class="hljs-keyword">do</span> new:add(x) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> new <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>mid()<br>Central tendency.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:mid</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.mu <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>norm(x : num)<br>Return <code>x</code> mapped into 0..1 for lo..hi.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:norm</span><span class="hljs-params">(x,    a)</span></span>
  <span class="hljs-keyword">if</span> x ==<span class="hljs-string">&quot;?&quot;</span> <span class="hljs-keyword">then</span> <span class="hljs-keyword">return</span> x <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">return</span> (x-<span class="hljs-built_in">self</span>.lo) / (<span class="hljs-built_in">self</span>.hi - <span class="hljs-built_in">self</span>.lo + <span class="hljs-number">1E-32</span>) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>var()<br>Variance  of numerics  is the  standard deviation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:var</span><span class="hljs-params">()</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">self</span>.sd <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>same(other : Num, the:table)<br>Are two distributions the same?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:same</span><span class="hljs-params">(other, the)</span></span>
  <span class="hljs-keyword">return</span> same(<span class="hljs-built_in">self</span>.some:all(), other.some:all(), the) <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>tile(width : int, ps : float+)<br>For all the <code>Nums</code> in <code>t</code>, print out normalized
in the <code>lo</code>..<code>hi</code> range of <code>self</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Num:tile</span><span class="hljs-params">(t,width,ps,    a,s,where)</span></span>
  a = <span class="hljs-built_in">self</span>.some:all()
  s = {}
  <span class="hljs-keyword">for</span> i = <span class="hljs-number">1</span>, (width <span class="hljs-keyword">or</span> <span class="hljs-number">32</span>) <span class="hljs-keyword">do</span> s[i]=<span class="hljs-string">&quot; &quot;</span> <span class="hljs-keyword">end</span>
  where = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(n)</span></span> <span class="hljs-keyword">return</span> <span class="hljs-built_in">math</span>.<span class="hljs-built_in">floor</span>(width*<span class="hljs-built_in">self</span>:norm(n)) <span class="hljs-keyword">end</span>
  pos   = <span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(p)</span></span> <span class="hljs-keyword">return</span> a[<span class="hljs-number">1</span>] + p*(a[#a] - a[<span class="hljs-number">1</span>]) <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">for</span> p=<span class="hljs-number">.1</span>,<span class="hljs-number">.3</span>,<span class="hljs-number">.01</span> <span class="hljs-keyword">do</span> s[where(pos(p))] =<span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">end</span> 
  <span class="hljs-keyword">for</span> p=<span class="hljs-number">.7</span>,<span class="hljs-number">.9</span>,<span class="hljs-number">.01</span> <span class="hljs-keyword">do</span> s[where(pos(p))] =<span class="hljs-string">&quot;-&quot;</span> <span class="hljs-keyword">end</span> 
  s[where(<span class="hljs-built_in">self</span>.some:mid())] = <span class="hljs-string">&quot;|&quot;</span>
  <span class="hljs-keyword">return</span> {rank= <span class="hljs-built_in">self</span>.rank <span class="hljs-keyword">or</span> <span class="hljs-number">0</span>,
          str = <span class="hljs-built_in">table</span>.<span class="hljs-built_in">concat</span>(s), 
          mid = per(<span class="hljs-built_in">self</span>.some:all()),
          per = map(ps <span class="hljs-keyword">or</span> {<span class="hljs-number">.25</span>, <span class="hljs-number">.5</span>, <span class="hljs-number">.75</span>}, 
                    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(p)</span></span> <span class="hljs-keyword">return</span> per(<span class="hljs-built_in">self</span>:all(),p) <span class="hljs-keyword">end</span>)} <span class="hljs-keyword">end</span></pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <hr>

            </div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-keyword">return</span> Num</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
