<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">
<!--
generated by Pygments <https://pygments.org/>
Copyright 2006-2021 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
-->
<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <style type="text/css">
/*
generated by Pygments <https://pygments.org/>
Copyright 2006-2021 by the Pygments team.
Licensed under the BSD license, see LICENSE for details.
*/
pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
body .hll { background-color: #ffffcc }
body { background: #ffffff; }
body .c { color: #008000 } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #0000ff } /* Keyword */
body .ch { color: #008000 } /* Comment.Hashbang */
body .cm { color: #008000 } /* Comment.Multiline */
body .cp { color: #0000ff } /* Comment.Preproc */
body .cpf { color: #008000 } /* Comment.PreprocFile */
body .c1 { color: #008000 } /* Comment.Single */
body .cs { color: #008000 } /* Comment.Special */
body .ge { font-style: italic } /* Generic.Emph */
body .gh { font-weight: bold } /* Generic.Heading */
body .gp { font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { font-weight: bold } /* Generic.Subheading */
body .kc { color: #0000ff } /* Keyword.Constant */
body .kd { color: #0000ff } /* Keyword.Declaration */
body .kn { color: #0000ff } /* Keyword.Namespace */
body .kp { color: #0000ff } /* Keyword.Pseudo */
body .kr { color: #0000ff } /* Keyword.Reserved */
body .kt { color: #2b91af } /* Keyword.Type */
body .s { color: #a31515 } /* Literal.String */
body .nc { color: #2b91af } /* Name.Class */
body .ow { color: #0000ff } /* Operator.Word */
body .sa { color: #a31515 } /* Literal.String.Affix */
body .sb { color: #a31515 } /* Literal.String.Backtick */
body .sc { color: #a31515 } /* Literal.String.Char */
body .dl { color: #a31515 } /* Literal.String.Delimiter */
body .sd { color: #a31515 } /* Literal.String.Doc */
body .s2 { color: #a31515 } /* Literal.String.Double */
body .se { color: #a31515 } /* Literal.String.Escape */
body .sh { color: #a31515 } /* Literal.String.Heredoc */
body .si { color: #a31515 } /* Literal.String.Interpol */
body .sx { color: #a31515 } /* Literal.String.Other */
body .sr { color: #a31515 } /* Literal.String.Regex */
body .s1 { color: #a31515 } /* Literal.String.Single */
body .ss { color: #a31515 } /* Literal.String.Symbol */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight" style="background: #ffffff"><pre style="line-height: 125%;"><span></span><span style="color: #0000ff">#!/usr/bin/env lua</span>
<span style="color: #008000">-- vim: filetype=lua ts=2 sw=2 sts=2 et :</span>
<span style="color: #0000ff">local</span> b4={}; <span style="color: #0000ff">for</span> k,_ <span style="color: #0000ff">in</span> pairs(_ENV) <span style="color: #0000ff">do</span> b4[k]=k <span style="color: #0000ff">end</span>
<span style="color: #0000ff">local</span> about=<span style="color: #a31515">[[</span>
<span style="color: #a31515"> ,-_|\   Contrast set learning</span>
<span style="color: #a31515">/     \  (c) Tim Menzies, 2021, unlicense.org</span>
<span style="color: #a31515">\_,-._*  Cluster, then report just the </span>
<span style="color: #a31515">     v   deltas between nearby clusters.]]</span>
<span style="color: #0000ff">local</span> argparse = require(<span style="color: #a31515">&quot;argparse&quot;</span>)
<span style="color: #0000ff">local</span> Obj={}

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> config() <span style="color: #0000ff">return</span> {
  bins=    {.5     ,<span style="color: #a31515">&#39;Bins are of size n**BINS&#39;</span>},
  cols=    {<span style="color: #a31515">&#39;x&#39;</span>    ,<span style="color: #a31515">&#39;Columns to use for inference&#39;</span>},
  data=    {<span style="color: #a31515">&#39;../data/auto2.csv&#39;</span>, 
                   <span style="color: #a31515">&#39;Where to read data&#39;</span>},
  far=     {.9     ,<span style="color: #a31515">&#39;Where to look for far things&#39;</span>},
  goaL=    {<span style="color: #a31515">&#39;best&#39;</span> ,<span style="color: #a31515">&#39;Learning goals: best|rest|other&#39;</span>},
  iota=    {.3     ,<span style="color: #a31515">&#39;Small = sd**iota&#39;</span>},
  k=       {2      ,<span style="color: #a31515">&#39;Bayes low class frequency hack&#39;</span>},
  m=       {1      ,<span style="color: #a31515">&#39;Bayes low range frequency hack&#39;</span>},
  p=       {2      ,<span style="color: #a31515">&#39;Distance calculation exponent&#39;</span>},
  samples= {20     ,<span style="color: #a31515">&#39;Number of samples to find far things&#39;</span>},
  seed=    {10013  ,<span style="color: #a31515">&#39;Seed for random numbers&#39;</span>},
  top=     {10     ,<span style="color: #a31515">&#39;Focus on this many&#39;</span>},
  unsafe=  {<span style="color: #0000ff">false</span>  ,<span style="color: #a31515">&#39;Run examples, no protection&#39;</span>},
  verbose= {<span style="color: #0000ff">false</span>  ,<span style="color: #a31515">&#39;Set verbose&#39;</span>},
  xample=  {<span style="color: #a31515">&quot;&quot;</span>     ,<span style="color: #a31515">&quot;&#39;-x ls&#39; lists all, &#39;-x all&#39; runs all&quot;</span>}} <span style="color: #0000ff">end</span>

<span style="color: #000;">--[[</span>

<span style="color: #000;"><h1>asds</h1></span>

<span style="color: #000;">asd</span>
<span style="color: #008000">asd</span>
<span style="color: #008000">asd</span>
<span style="color: #008000">asd</span>

<span style="color: #008000">--]]</span>
<span style="color: #008000">-----------------------------------------------------------</span>
<span style="color: #008000">--- Columns</span>
<span style="color: #0000ff">local</span> Num={}
<span style="color: #0000ff">function</span> <span style="color: #2b91af">Num</span>:new(at,s)
  <span style="color: #0000ff">return</span> Obj.new(self,<span style="color: #a31515">&quot;Num&quot;</span>,{
    at = at <span style="color: #0000ff">or</span> 0, txt = s <span style="color: #0000ff">or</span> <span style="color: #a31515">&quot;&quot;</span>, n = 0,_all = {},ok = <span style="color: #0000ff">false</span>,
    w = s:match(<span style="color: #a31515">&quot;-&quot;</span>) <span style="color: #0000ff">and</span> -1 <span style="color: #0000ff">or</span> 1}) <span style="color: #0000ff">end</span>

<span style="color: #0000ff">function</span> <span style="color: #2b91af">Num</span>:add(x)
  <span style="color: #0000ff">if</span>  x ~= <span style="color: #a31515">&quot;?&quot;</span> <span style="color: #0000ff">then</span>
    self.n = self.n + 1
    self._all[ 1 + #self._all] = x
    self.ok= <span style="color: #0000ff">false</span> <span style="color: #0000ff">end</span>
  <span style="color: #0000ff">return</span> x <span style="color: #0000ff">end</span> 

<span style="color: #008000">-----------------------------------------------------------</span>
<span style="color: #008000">--- Utils</span>
<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> sorted(t,         i,keys)
  i,keys = 0,{}
  <span style="color: #0000ff">for</span> k <span style="color: #0000ff">in</span> pairs(t) <span style="color: #0000ff">do</span> keys[#keys+1] = k <span style="color: #0000ff">end</span>
  table.sort(keys)
  <span style="color: #0000ff">return</span> <span style="color: #0000ff">function</span> ()
    <span style="color: #0000ff">if</span> i &lt; #keys <span style="color: #0000ff">then</span>
      i=i+1; <span style="color: #0000ff">return</span> keys[i], t[keys[i]] <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> map(a,f,     b)
  b, f = {}, f <span style="color: #0000ff">or</span> <span style="color: #0000ff">function</span>(z) <span style="color: #0000ff">return</span> z <span style="color: #0000ff">end</span>
  <span style="color: #0000ff">for</span> i,v <span style="color: #0000ff">in</span> pairs(a <span style="color: #0000ff">or</span> {}) <span style="color: #0000ff">do</span> b[i] = f(v) <span style="color: #0000ff">end</span> 
  <span style="color: #0000ff">return</span> b <span style="color: #0000ff">end</span> 

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> copy(t) <span style="color: #0000ff">return</span> type(t)~=<span style="color: #a31515">&#39;table&#39;</span> <span style="color: #0000ff">and</span> t <span style="color: #0000ff">or</span> map(t,copy) <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> fmt(s,...) <span style="color: #0000ff">return</span> io.write(s:format(...)) <span style="color: #0000ff">end</span> 

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> color(s,...)
  <span style="color: #0000ff">local</span> col={red=31, green=32, yellow=33, purple=34}
  print(<span style="color: #a31515">&#39;\27[1m\27[&#39;</span>.. col[s] ..<span style="color: #a31515">&#39;m&#39;</span>..string.format(...)..<span style="color: #a31515">&#39;\27[0m&#39;</span>) <span style="color: #0000ff">end</span>

<span style="color: #0000ff">function</span> dump(o)
  <span style="color: #0000ff">local</span> sep, s, keys = <span style="color: #a31515">&quot;&quot;</span>, (o._name <span style="color: #0000ff">or</span> <span style="color: #a31515">&quot;&quot;</span>) ..<span style="color: #a31515">&quot;{&quot;</span>, {}
  <span style="color: #0000ff">for</span> key,_ <span style="color: #0000ff">in</span> pairs(o) <span style="color: #0000ff">do</span> keys[#keys+1] = key <span style="color: #0000ff">end</span>
  table.sort(keys)
  <span style="color: #0000ff">for</span> _,k <span style="color: #0000ff">in</span> pairs(keys) <span style="color: #0000ff">do</span> 
    s=s .. sep .. tostring(k)..<span style="color: #a31515">&quot;=&quot;</span>..tostring(o[k])
    sep=<span style="color: #a31515">&quot;, &quot;</span> <span style="color: #0000ff">end</span> 
  <span style="color: #0000ff">return</span> s..<span style="color: #a31515">&quot;}&quot;</span> <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> rump(t,pre,    indent,fmt)
  pre, indent = pre <span style="color: #0000ff">or</span> <span style="color: #a31515">&quot;&quot;</span>, indent <span style="color: #0000ff">or</span> 0
  <span style="color: #0000ff">if</span> indent &lt; 10 <span style="color: #0000ff">then</span>
    <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span> pairs(t <span style="color: #0000ff">or</span> {}) <span style="color: #0000ff">do</span>
      <span style="color: #0000ff">if</span> <span style="color: #0000ff">not</span> (type(k)==<span style="color: #a31515">&#39;string&#39;</span> <span style="color: #0000ff">and</span> k:match(<span style="color: #a31515">&quot;^_&quot;</span>)) <span style="color: #0000ff">then</span>
        fmt= pre..string.rep(<span style="color: #a31515">&quot;|  &quot;</span>,indent)..tostring(k)..<span style="color: #a31515">&quot;: &quot;</span>
        <span style="color: #0000ff">if</span> type(v) == <span style="color: #a31515">&quot;table&quot;</span> <span style="color: #0000ff">then</span>
          print(fmt)
          rump(v, pre, indent+1)
        <span style="color: #0000ff">else</span>
          print(fmt .. tostring(v)) <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> pump(o) print(dump(o)) <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> seed = 10013
<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> park_miller_randomizer(     mult,mod)
  mult, mod = 16807.0, 2147483647.0
  seed = (mult * seed) % mod 
  <span style="color: #0000ff">return</span> seed / mod <span style="color: #0000ff">end</span> 

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> rand(lo,hi) 
  lo,hi = lo <span style="color: #0000ff">or</span> 0, hi <span style="color: #0000ff">or</span> 1
  <span style="color: #0000ff">return</span> lo + (hi-lo)*park_miller_randomizer() <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> csv(file,       split,stream,tmp)
  stream = file <span style="color: #0000ff">and</span> io.input(file) <span style="color: #0000ff">or</span> io.input()
  tmp    = io.read()
  <span style="color: #0000ff">return</span> <span style="color: #0000ff">function</span>(       t)
    <span style="color: #0000ff">if</span> tmp <span style="color: #0000ff">then</span>
      tmp = tmp:gsub(<span style="color: #a31515">&quot;[\t\r ]*&quot;</span>,<span style="color: #a31515">&quot;&quot;</span>):gsub(<span style="color: #a31515">&quot;#.*&quot;</span>,<span style="color: #a31515">&quot;&quot;</span>)
      t={}; <span style="color: #0000ff">for</span> y <span style="color: #0000ff">in</span> string.gmatch(tmp, <span style="color: #a31515">&quot;([^,]+)&quot;</span>) <span style="color: #0000ff">do</span> t[#t+1]=y <span style="color: #0000ff">end</span>
      tmp = io.read()
      <span style="color: #0000ff">if</span> #t &gt; 0 <span style="color: #0000ff">then</span>
        <span style="color: #0000ff">for</span> j,x <span style="color: #0000ff">in</span> pairs(t) <span style="color: #0000ff">do</span> t[j]=tonumber(x) <span style="color: #0000ff">or</span> x <span style="color: #0000ff">end</span>
        <span style="color: #0000ff">return</span> t <span style="color: #0000ff">end</span>
    <span style="color: #0000ff">else</span>
      io.close(stream) <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span>

<span style="color: #0000ff">function</span> <span style="color: #2b91af">Obj</span>:new(name, new)
  <span style="color: #0000ff">local</span> new = new <span style="color: #0000ff">or</span> {}
  setmetatable(new, self)
  self.__tostring = dump 
  self.__index    = self
  self._name      = name
  <span style="color: #0000ff">return</span> new <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> cli(what,about,t,       arg,b4)
  arg = argparse(what, about)
  <span style="color: #0000ff">for</span> flag,v <span style="color: #0000ff">in</span> sorted(t) <span style="color: #0000ff">do</span>
    flag = <span style="color: #a31515">&quot;--&quot;</span>..flag
    b4 =<span style="color: #a31515">&quot; (default: &quot;</span>..tostring(v[1])..<span style="color: #a31515">&quot;)&quot;</span>
    <span style="color: #0000ff">if</span>     v[1]==<span style="color: #0000ff">false</span>
    <span style="color: #0000ff">then</span>   arg:flag(flag, v[2],  v[1])
    <span style="color: #0000ff">elseif</span> type(v[1])==<span style="color: #a31515">&quot;number&quot;</span>
    <span style="color: #0000ff">then</span>   arg:option(flag, v[2]..b4, v[1],tonumber)
    <span style="color: #0000ff">else</span>   arg:option(flag, v[2]    , v[1]) <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span> 
  <span style="color: #0000ff">return</span> arg:parse() <span style="color: #0000ff">end</span>

<span style="color: #008000">-----------------------------------------------------------</span>
<span style="color: #008000">--- Unit tests</span>
<span style="color: #0000ff">local</span> Eg={}
Eg.one= {
  txt = <span style="color: #a31515">&quot;demo&quot;</span>,
  fun = <span style="color: #0000ff">function</span> (the) 
        <span style="color: #0000ff">for</span> k,v <span style="color: #0000ff">in</span> sorted(Eg) <span style="color: #0000ff">do</span> print(k, v.txt) <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span>}

Eg.two= {
  txt = <span style="color: #a31515">&quot;two two&quot;</span>,
  fun = <span style="color: #0000ff">function</span>  (the) print(the.seed) <span style="color: #0000ff">end</span> }

<span style="color: #008000">-----------------------------------------------------------</span>
<span style="color: #008000">--- Start up</span>
<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> run(name,fails,the,      fun,txt)
  the  = copy(the)
  seed = the.seed
  fun  = Eg[name].fun
  txt  = Eg[name].txt
  <span style="color: #0000ff">if</span>     the.unsafe==<span style="color: #0000ff">true</span> 
  <span style="color: #0000ff">then</span>   print(<span style="color: #a31515">&quot;unsafe:&quot;</span>); fun(the); os.exit(0)
  <span style="color: #0000ff">elseif</span> pcall(<span style="color: #0000ff">function</span> () fun(the) <span style="color: #0000ff">end</span>)
  <span style="color: #0000ff">then</span>   color(<span style="color: #a31515">&quot;green&quot;</span>,<span style="color: #a31515">&quot;%-15s  %s\n&quot;</span>,name,txt)
  <span style="color: #0000ff">else</span>   color(<span style="color: #a31515">&quot;red&quot;</span>,  <span style="color: #a31515">&quot;%-15s  %s\n&quot;</span>,name,txt); fails=fails+1 <span style="color: #0000ff">end</span> 
  <span style="color: #0000ff">return</span> fails <span style="color: #0000ff">end</span>

<span style="color: #0000ff">local</span> <span style="color: #0000ff">function</span> main(the,      fails)
  fails= 0
  <span style="color: #0000ff">if</span>     the.xample==<span style="color: #a31515">&quot;all&quot;</span> 
  <span style="color: #0000ff">then</span>   <span style="color: #0000ff">for</span> name,meta <span style="color: #0000ff">in</span> sorted(Eg) <span style="color: #0000ff">do</span>
         fails=run(name, fails, the) <span style="color: #0000ff">end</span> 
  <span style="color: #0000ff">elseif</span> the.xample==<span style="color: #a31515">&quot;ls&quot;</span> 
  <span style="color: #0000ff">then</span>   print(<span style="color: #a31515">&quot;\nexamples:&quot;</span>)
         <span style="color: #0000ff">for</span> x,y <span style="color: #0000ff">in</span> sorted(Eg) <span style="color: #0000ff">do</span> fmt(<span style="color: #a31515">&quot;  %-15s  %s\n&quot;</span>,x,y.txt) <span style="color: #0000ff">end</span> 
  <span style="color: #0000ff">elseif</span> the.xample <span style="color: #0000ff">and</span> Eg[the.xample] 
  <span style="color: #0000ff">then</span>   fails = run(the.xample, fails, the) <span style="color: #0000ff">end</span>
  os.exit(fails) <span style="color: #0000ff">end</span>
  
main( cli(<span style="color: #a31515">&quot;./keys&quot;</span>, about, config()) )
<span style="color: #0000ff">for</span> k,_ <span style="color: #0000ff">in</span> pairs(_ENV) <span style="color: #0000ff">do</span> <span style="color: #0000ff">if</span> <span style="color: #0000ff">not</span> b4[k] <span style="color: #0000ff">then</span> print(<span style="color: #a31515">&quot;?? &quot;</span>..k) <span style="color: #0000ff">end</span> <span style="color: #0000ff">end</span>
</pre></div>
</body>
</html>
